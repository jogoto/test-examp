pipeline {
    agent any
    
    environment {
        DOTNET_VERSION = '6.0'
        SOLUTION_FILE = 'HouseRentingSystem.sln'
        TEST_RESULTS_DIR = 'test-results'
        DOTNET_PATH = '/var/lib/jenkins/.dotnet/dotnet'
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    // –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∫–æ–¥–∞ –æ—Ç Git
                    checkout scm
                    echo "‚úÖ –ö–æ–¥—ä—Ç –µ –∏–∑–≤–ª–µ—á–µ–Ω —É—Å–ø–µ—à–Ω–æ"
                }
            }
        }
        
        stage('Clean and Restore') {
            steps {
                script {
                    echo '–û—á–∏—Å—Ç–≤–∞–Ω–µ –∏ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏...'
                    sh '''
                        # –û—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ obj –∏ bin –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏—Ç–µ (–∞–∫–æ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞—Ç)
                        find . -name "obj" -type d -exec rm -rf {} + 2>/dev/null || true
                        find . -name "bin" -type d -exec rm -rf {} + 2>/dev/null || true
                        
                        # –û—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ test-results –∏ TestResults –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏—Ç–µ
                        rm -rf test-results TestResults 2>/dev/null || true
                        
                        # –í—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏—Ç–µ
                        ${DOTNET_PATH} restore ${SOLUTION_FILE}
                    '''
                }
            }
        }
        
        stage('Build') {
            steps {
                script {
                    echo '–ö–æ–º–ø–∏–ª–∏—Ä–∞–Ω–µ –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ—Ç–æ...'
                    sh '${DOTNET_PATH} build ${SOLUTION_FILE} --configuration Release --no-restore'
                }
            }
            post {
                always {
                    // –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ build –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏ (—Å–∞–º–æ .dll —Ñ–∞–π–ª–æ–≤–µ)
                    archiveArtifacts artifacts: '**/bin/Release/**/*.dll', fingerprint: true
                }
            }
        }
        
        stage('Run All Tests') {
            steps {
                script {
                    echo '–ò–∑–ø—ä–ª–Ω—è–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ —Ç–µ—Å—Ç–æ–≤–µ...'
                    
                    // –°—ä–∑–¥–∞–≤–∞–Ω–µ –Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∑–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                    sh 'mkdir -p ${TEST_RESULTS_DIR}'
                    
                    // –ò–∑–ø—ä–ª–Ω—è–≤–∞–Ω–µ –Ω–∞ –≤—Å–∏—á–∫–∏ —Ç–µ—Å—Ç–æ–≤–µ —Å coverage
                    sh '''
                        ${DOTNET_PATH} test ${SOLUTION_FILE} \
                            --configuration Release \
                            --no-build \
                            --logger "trx;LogFileName=test-results.trx" \
                            --results-directory ${TEST_RESULTS_DIR} \
                            --collect "XPlat Code Coverage"
                    '''
                }
            }
            post {
                always {
                    // –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ test —Ä–µ–∑—É–ª—Ç–∞—Ç–∏
                    junit testResults: '${TEST_RESULTS_DIR}/**/*.trx'
                    
                    // –ê—Ä—Ö–∏–≤–∏—Ä–∞–Ω–µ –Ω–∞ coverage —Ä–µ–∑—É–ª—Ç–∞—Ç–∏ (—Ç–µ —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç –≤ TestResults –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è)
                    archiveArtifacts artifacts: 'TestResults/**/*', fingerprint: true
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'Pipeline –∑–∞–≤—ä—Ä—à–∏ —Å —Ä–µ–∑—É–ª—Ç–∞—Ç: ' + currentBuild.result
            }
        }
        success {
            script {
                echo '‚úÖ Pipeline –∑–∞–≤—ä—Ä—à–∏ —É—Å–ø–µ—à–Ω–æ!'
                echo 'üìä –í—Å–∏—á–∫–∏ —Ç–µ—Å—Ç–æ–≤–µ —Å–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ'
                echo 'üìà –û—Ç—á–µ—Ç–∏—Ç–µ –∑–∞ –ø–æ–∫—Ä–∏—Ç–∏–µ –Ω–∞ –∫–æ–¥–∞ —Å–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∏'
            }
        }
        failure {
            script {
                echo '‚ùå Pipeline –∑–∞–≤—ä—Ä—à–∏ —Å –≥—Ä–µ—à–∫–∞!'
                echo 'üîç –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –ª–æ–≥–æ–≤–µ—Ç–µ –∑–∞ –ø–æ–≤–µ—á–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
            }
        }
        unstable {
            script {
                echo '‚ö†Ô∏è Pipeline –∑–∞–≤—ä—Ä—à–∏ –Ω–µ—É—Å–ø–µ—à–Ω–æ (—Ç–µ—Å—Ç–æ–≤–µ –ø—Ä–æ–≤–∞–ª–µ–Ω–∏)'
                echo 'üîç –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ—Ç —Ç–µ—Å—Ç–æ–≤–µ—Ç–µ'
            }
        }
    }
} 